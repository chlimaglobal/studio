
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: safe check if user doc exists and has memberIds
    function isSameCouple(targetUserId) {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && exists(/databases/$(database)/documents/users/$(targetUserId))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberIds != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberIds.hasAny([request.auth.uid])
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberIds.hasAny(get(/databases/$(database)/documents/users/$(targetUserId)).data.memberIds);
    }

    // USERS
    match /users/{userId} {
      // Owner can read/write their document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Partner (member of same couple) can read
      allow read: if request.auth != null
        && resource.data.memberIds != null
        && resource.data.memberIds.hasAny([request.auth.uid]);
      
      // Creation allowed for authenticated users
      allow create: if request.auth != null;
    }

    // COUPLES
    match /couples/{coupleId} {
      allow read: if request.auth != null
        && resource.data.members != null
        && resource.data.members.hasAny([request.auth.uid]);

      // creation must be validated server-side (trusted)
      allow create: if false; // disallow client creation; server should create couples
      allow update, delete: if false; // disallow client-side updates; server should manage
    }

    // INVITES
    match /invites/{inviteId} {
      // Allow user to create an invite for themselves
      allow create: if request.auth != null && request.resource.data.sentBy == request.auth.uid;
      
      // Allow read/write only to sender or recipient
      allow read, write: if request.auth != null &&
        (resource.data.sentBy == request.auth.uid ||
         request.auth.token.email == resource.data.sentToEmail
        );
        
      // NEW RULE: Allow listing invites if the query is specific to the user
      allow list: if request.auth != null &&
                      (request.query.limit <= 1 &&
                       (request.query.where.size() == 2 && request.query.where[0][0] == 'sentBy' && request.query.where[0][2] == request.auth.uid && request.query.where[1][0] == 'status' && request.query.where[1][2] == 'pending') ||
                       (request.query.where.size() == 2 && request.query.where[0][0] == 'sentToEmail' && request.query.where[0][2] == request.auth.token.email && request.query.where[1][0] == 'status' && request.query.where[1][2] == 'pending')
                      );
    }

    // Default: deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

    